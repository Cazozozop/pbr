<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Convertisseur PBR - ZIP & Images</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body style="font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px;">
  <h1>üñºÔ∏è Convertisseur PBR avec effet de relief</h1>
  <p>Importe jusqu‚Äô√† 5000 images (ou un .zip d‚Äôimages)</p>
  <input type="file" id="input" multiple accept=".zip,image/*"><br><br>
  <progress id="progress" value="0" max="1" style="width:70%;display:none;"></progress><br><br>
  <button id="start">üì¶ Convertir et T√©l√©charger</button>

  <script>
    const input = document.getElementById("input");
    const button = document.getElementById("start");
    const progress = document.getElementById("progress");

    function upscale(img, scale = 4) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas;
    }

    function getLum(data, x, y, w) {
      const i = (y * w + x) * 4;
      return (data[i] + data[i + 1] + data[i + 2]) / 3 / 255;
    }

    function generateNormalMap(canvas) {
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext("2d");
      const src = ctx.getImageData(0, 0, w, h);
      const dst = ctx.createImageData(w, h);

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = (y * w + x) * 4;
          const dx = getLum(src.data, x + 1, y, w) - getLum(src.data, x - 1, y, w);
          const dy = getLum(src.data, x, y + 1, w) - getLum(src.data, x, y - 1, w);
          const dz = 1;
          const len = Math.sqrt(dx * dx + dy * dy + dz * dz);
          const r = (dx / len * 0.5 + 0.5) * 255;
          const g = (dy / len * 0.5 + 0.5) * 255;
          const b = (dz / len * 0.5 + 0.5) * 255;
          dst.data[i] = r;
          dst.data[i + 1] = g;
          dst.data[i + 2] = b;
          dst.data[i + 3] = 255;
        }
      }
      ctx.putImageData(dst, 0, 0);
      return canvas;
    }

    async function processImageFile(file, zipOut, i, total) {
      return new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = async () => {
          let canvas = upscale(img);
          canvas = generateNormalMap(canvas);
          canvas.toBlob((blob) => {
            zipOut.file(file.name.replace(/\.\w+$/, "_PBR.png"), blob);
            URL.revokeObjectURL(url);
            progress.value = (i + 1) / total;
            resolve();
          }, "image/png");
        };
        img.src = url;
      });
    }

    async function handleFiles(files) {
      progress.style.display = "block";
      const zipOut = new JSZip();
      let allImages = [];

      for (const file of files) {
        if (file.name.endsWith(".zip")) {
          const zip = await JSZip.loadAsync(file);
          const entries = Object.values(zip.files).filter(f => !f.dir && /\.(png|jpg|jpeg)$/i.test(f.name));
          for (const entry of entries) {
            const blob = await entry.async("blob");
            const imageFile = new File([blob], entry.name, { type: blob.type });
            allImages.push(imageFile);
          }
        } else if (file.type.startsWith("image/")) {
          allImages.push(file);
        }
      }

      if (allImages.length === 0) {
        alert("Aucune image trouv√©e.");
        return;
      }
      if (allImages.length > 5000) {
        alert("Maximum 5000 images !");
        return;
      }

      for (let i = 0; i < allImages.length; i++) {
        await processImageFile(allImages[i], zipOut, i, allImages.length);
      }

      const zipBlob = await zipOut.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(zipBlob);
      link.download = "images_PBR_converties.zip";
      link.click();

      progress.value = 1;
      setTimeout(() => progress.style.display = "none", 2000);
    }

    button.onclick = () => {
      if (!input.files.length) {
        alert("Ajoute des images ou un fichier ZIP !");
        return;
      }
      handleFiles(input.files);
    };
  </script>
</body>
</html>
