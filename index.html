<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Convertisseur PBR visuel (relief)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body style="background:#111;color:white;font-family:sans-serif;text-align:center;padding:20px">
  <h1>üñºÔ∏è Convertisseur PBR visuel (relief appliqu√©)</h1>
  <input type="file" id="input" multiple accept=".zip,image/*"><br><br>
  <progress id="progress" value="0" max="1" style="width:70%;display:none;"></progress><br><br>
  <button id="start">‚öôÔ∏è Convertir les images</button><br><br>
  <button id="download-original" disabled>üì• T√©l√©charger images agrandies</button>
  <button id="download-relief" disabled>üì• T√©l√©charger images avec relief</button>

  <script>
    const input = document.getElementById("input");
    const progress = document.getElementById("progress");
    const startBtn = document.getElementById("start");
    const btnOriginal = document.getElementById("download-original");
    const btnRelief = document.getElementById("download-relief");

    function upscale(img, scale = 4) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas;
    }

    function getLum(data, x, y, w) {
      const i = (y * w + x) * 4;
      return (data[i] + data[i+1] + data[i+2]) / 3 / 255;
    }

    function generateNormalMap(canvas) {
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext("2d");
      const src = ctx.getImageData(0, 0, w, h);
      const dst = ctx.createImageData(w, h);

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = (y * w + x) * 4;
          const alpha = src.data[i+3];
          if (alpha < 10) {
            dst.data.set([0,0,0,0], i);
            continue;
          }

          const dx = getLum(src.data, x+1, y, w) - getLum(src.data, x-1, y, w);
          const dy = getLum(src.data, x, y+1, w) - getLum(src.data, x, y-1, w);
          const dz = 1;
          const len = Math.sqrt(dx*dx + dy*dy + dz*dz);
          const nx = dx/len, ny = dy/len, nz = dz/len;

          dst.data[i] = (nx * 0.5 + 0.5) * 255;
          dst.data[i+1] = (ny * 0.5 + 0.5) * 255;
          dst.data[i+2] = (nz * 0.5 + 0.5) * 255;
          dst.data[i+3] = alpha;
        }
      }
      return dst;
    }

    function normalize(v) {
      const len = Math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2]);
      return [v[0]/len, v[1]/len, v[2]/len];
    }

    function applyLighting(canvas, normalMapData, lightDir = [-0.5, -0.5, 1]) {
      const w = canvas.width, h = canvas.height;
      const light = normalize(lightDir);

      const offCanvas = document.createElement("canvas");
      offCanvas.width = w;
      offCanvas.height = h;
      const offCtx = offCanvas.getContext("2d");
      offCtx.drawImage(canvas, 0, 0);
      const imgData = offCtx.getImageData(0, 0, w, h);

      for (let i = 0; i < imgData.data.length; i += 4) {
        const r = normalMapData.data[i];
        const g = normalMapData.data[i + 1];
        const b = normalMapData.data[i + 2];
        const a = normalMapData.data[i + 3];

        if (a < 10) continue;

        const nx = r / 255 * 2 - 1;
        const ny = g / 255 * 2 - 1;
        const nz = b / 255 * 2 - 1;

        const dot = Math.max(0.3, nx * light[0] + ny * light[1] + nz * light[2]); // 0.3 min lumi√®re

        imgData.data[i] *= dot;
        imgData.data[i+1] *= dot;
        imgData.data[i+2] *= dot;
      }

      offCtx.putImageData(imgData, 0, 0);
      return offCanvas;
    }

    async function extractFiles(fileList) {
      let images = [];
      for (const file of fileList) {
        if (file.name.endsWith(".zip")) {
          const zip = await JSZip.loadAsync(file);
          const entries = Object.values(zip.files).filter(f => !f.dir && /\.(png|jpe?g)$/i.test(f.name));
          for (const entry of entries) {
            const blob = await entry.async("blob");
            images.push(new File([blob], entry.name, { type: blob.type }));
          }
        } else if (file.type.startsWith("image/")) {
          images.push(file);
        }
      }
      return images.slice(0, 5000);
    }

    async function loadImage(file) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }

    startBtn.onclick = async () => {
      if (!input.files.length) return alert("Ajoute des images ou un zip !");
      progress.style.display = "block";
      progress.value = 0;

      const files = await extractFiles(input.files);
      const zipOriginal = new JSZip();
      const zipRelief = new JSZip();

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const img = await loadImage(file);
        const name = file.name.replace(/\.\w+$/, "");
        const canvas = upscale(img);

        const normalMap = generateNormalMap(canvas);
        const litCanvas = applyLighting(canvas, normalMap);

        const blobOriginal = await new Promise(res => canvas.toBlob(res, "image/png"));
        const blobRelief = await new Promise(res => litCanvas.toBlob(res, "image/png"));

        zipOriginal.file(name + "_x4.png", blobOriginal);
        zipRelief.file(name + "_relief.png", blobRelief);

        progress.value = (i + 1) / files.length;
      }

      const zip1 = await zipOriginal.generateAsync({ type: "blob" });
      const zip2 = await zipRelief.generateAsync({ type: "blob" });

      btnOriginal.disabled = false;
      btnRelief.disabled = false;

      btnOriginal.onclick = () => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(zip1);
        link.download = "images_agrandies.zip";
        link.click();
      };

      btnRelief.onclick = () => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(zip2);
        link.download = "images_relief.zip";
        link.click();
      };

      setTimeout(() => progress.style.display = "none", 2000);
    };
  </script>
</body>
</html>
