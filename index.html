<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Convertisseur PBR - Relief & T√©l√©chargements</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body style="font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px;">
  <h1>üñºÔ∏è Convertisseur PBR - Agrandissement & Relief</h1>
  <input type="file" id="input" multiple accept=".zip,image/*"><br><br>
  <progress id="progress" value="0" max="1" style="width:70%;display:none;"></progress><br><br>
  <button id="start">‚öôÔ∏è Convertir les images</button><br><br>
  <button id="download-original" disabled>üì• T√©l√©charger les images agrandies</button>
  <button id="download-pbr" disabled>üì• T√©l√©charger les images avec PBR</button>

  <script>
    const input = document.getElementById("input");
    const progress = document.getElementById("progress");
    const startBtn = document.getElementById("start");
    const downloadOriginalBtn = document.getElementById("download-original");
    const downloadPBRBtn = document.getElementById("download-pbr");

    function upscale(img, scale = 4) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas;
    }

    function getLum(data, x, y, w) {
      const i = (y * w + x) * 4;
      return (data[i] + data[i + 1] + data[i + 2]) / 3 / 255;
    }

    function generateNormalMap(canvas) {
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext("2d");
      const src = ctx.getImageData(0, 0, w, h);
      const dst = ctx.createImageData(w, h);

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = (y * w + x) * 4;
          const alpha = src.data[i + 3];
          if (alpha < 10) {
            dst.data.set([0, 0, 0, 0], i);
            continue;
          }

          const dx = getLum(src.data, x + 1, y, w) - getLum(src.data, x - 1, y, w);
          const dy = getLum(src.data, x, y + 1, w) - getLum(src.data, x, y - 1, w);
          const dz = 1;
          const len = Math.sqrt(dx * dx + dy * dy + dz * dz);
          const r = (dx / len * 0.5 + 0.5) * 255;
          const g = (dy / len * 0.5 + 0.5) * 255;
          const b = (dz / len * 0.5 + 0.5) * 255;

          dst.data[i] = r;
          dst.data[i + 1] = g;
          dst.data[i + 2] = b;
          dst.data[i + 3] = alpha;
        }
      }

      ctx.putImageData(dst, 0, 0);
      return canvas;
    }

    async function loadImage(file) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }

    async function extractFiles(fileList) {
      let images = [];

      for (const file of fileList) {
        if (file.name.endsWith(".zip")) {
          const zip = await JSZip.loadAsync(file);
          const entries = Object.values(zip.files).filter(f => !f.dir && /\.(png|jpe?g)$/i.test(f.name));
          for (const entry of entries) {
            const blob = await entry.async("blob");
            images.push(new File([blob], entry.name, { type: blob.type }));
          }
        } else if (file.type.startsWith("image/")) {
          images.push(file);
        }
      }

      return images.slice(0, 5000); // max 5000 images
    }

    startBtn.onclick = async () => {
      if (!input.files.length) {
        alert("Ajoute des images ou un zip !");
        return;
      }

      progress.style.display = "block";
      progress.value = 0;
      downloadOriginalBtn.disabled = true;
      downloadPBRBtn.disabled = true;

      const files = await extractFiles(input.files);
      const zipOriginal = new JSZip();
      const zipPBR = new JSZip();

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const img = await loadImage(file);
        const name = file.name.replace(/\.\w+$/, "");

        const upscaledCanvas = upscale(img);
        const blobOriginal = await new Promise(res => upscaledCanvas.toBlob(res, "image/png"));
        zipOriginal.file(name + "_x4.png", blobOriginal);

        const pbrCanvas = generateNormalMap(upscaledCanvas);
        const blobPBR = await new Promise(res => pbrCanvas.toBlob(res, "image/png"));
        zipPBR.file(name + "_PBR.png", blobPBR);

        progress.value = (i + 1) / files.length;
      }

      const blobOriginalZip = await zipOriginal.generateAsync({ type: "blob" });
      const blobPBRZip = await zipPBR.generateAsync({ type: "blob" });

      downloadOriginalBtn.onclick = () => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blobOriginalZip);
        link.download = "images_agrandies.zip";
        link.click();
      };

      downloadPBRBtn.onclick = () => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blobPBRZip);
        link.download = "images_PBR.zip";
        link.click();
      };

      downloadOriginalBtn.disabled = false;
      downloadPBRBtn.disabled = false;

      setTimeout(() => progress.style.display = "none", 2000);
    };
  </script>
</body>
</html>
