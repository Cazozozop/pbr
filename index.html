<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Convertisseur PBR - Relief</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body style="font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px;">
  <h1>üñºÔ∏è Convertisseur PBR avec effet de relief</h1>
  <input type="file" id="input" multiple accept="image/*"><br><br>
  <progress id="progress" value="0" max="1" style="width:50%;display:none;"></progress><br><br>
  <button id="start">üì¶ Convertir et T√©l√©charger le ZIP</button>

  <script>
    const input = document.getElementById("input");
    const button = document.getElementById("start");
    const progress = document.getElementById("progress");

    function upscale(img, scale = 4) {
      const w = img.width * scale, h = img.height * scale;
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, 0, 0, w, h);
      return canvas;
    }

    function generateNormalMap(canvas) {
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext("2d");
      const src = ctx.getImageData(0, 0, w, h);
      const dst = ctx.createImageData(w, h);

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = (y * w + x) * 4;
          const sx = (getLum(src, x + 1, y) - getLum(src, x - 1, y)) / 2;
          const sy = (getLum(src, x, y + 1) - getLum(src, x, y - 1)) / 2;
          const sz = 1;
          const len = Math.sqrt(sx * sx + sy * sy + sz * sz);
          const r = (sx / len * 0.5 + 0.5) * 255;
          const g = (sy / len * 0.5 + 0.5) * 255;
          const b = (sz / len * 0.5 + 0.5) * 255;
          dst.data[i] = r; dst.data[i+1] = g; dst.data[i+2] = b; dst.data[i+3] = 255;
        }
      }
      ctx.putImageData(dst, 0, 0);
      return canvas;
    }

    function getLum(imgData, x, y) {
      const i = (y * imgData.width + x) * 4;
      const r = imgData.data[i], g = imgData.data[i+1], b = imgData.data[i+2];
      return (r + g + b) / 3 / 255;
    }

    button.onclick = async () => {
      const files = input.files;
      if (!files.length || files.length > 5000) {
        alert("Importe entre 1 et 5000 images.");
        return;
      }

      progress.style.display = "block";
      const zip = new JSZip();

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.src = url;
        await img.decode();

        let canvas = upscale(img);
        canvas = generateNormalMap(canvas);

        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        zip.file(file.name.replace(/\.\w+$/, "_PBR.png"), blob);
        progress.value = i / files.length;
      }

      zip.generateAsync({ type: "blob" }).then(blob => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "converted_pbr_images.zip";
        link.click();
      }).finally(() => {
        progress.value = 1;
        setTimeout(() => progress.style.display = "none", 1000);
      });
    };
  </script>
</body>
</html>
